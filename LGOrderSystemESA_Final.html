<!DOCTYPE html>
<html lang="en">

<script>
  // Check if session is active
  const company = sessionStorage.getItem("company");
  if (!company) {
    // Not logged in â†’ redirect to login page
    window.location.href = "login.html";
  }
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUCKYGLASS B2B Ordering System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f9ff;
            background-image: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
        }
        .product-image {
            width: 2.5cm;
            height: 2.5cm;
            object-fit: cover;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .product-card {
            border-left: 4px solid #60a5fa;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-left-color: #2563eb;
        }
        .notification {
            transition: all 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .add-to-cart-btn {
            background: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .add-to-cart-btn:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .submit-order-btn {
            background: linear-gradient(to right, #10b981, #059669);
        }
        .submit-order-btn:hover {
            background: linear-gradient(to right, #059669, #047857);
        }
        .pagination-btn {
            transition: all 0.2s ease;
        }
        .pagination-btn:hover:not(.active) {
            background-color: #e0e7ff;
        }
        .pagination-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .filter-btn {
            transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .filter-btn:hover:not(.active) {
            background-color: #e0e7ff;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .cbm-fill {
            background-color: #3b82f6;
        }
        .weight-fill {
            background-color: #10b981;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .search-result-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: #f3f4f6;
        }
        .search-result-item.active {
            background-color: #e5e7eb;
        }
        
        /* Responsive layout */
        @media (max-width: 1023px) {
            .three-column-layout {
                grid-template-columns: 1fr;
            }
            .sidebar, .order-summary {
                position: static;
                width: 100%;
                max-height: none;
            }
            .sidebar {
                margin-bottom: 1rem;
            }
            .order-summary {
                margin-top: 1rem;
            }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
        
        /* Container button styles */
        .container-btn {
            transition: all 0.3s ease;
        }
        .container-btn.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 500;
        }
        
        /* Product series name in RED */
        .series-name {
            color: #dc2626 !important; /* Red color */
            font-weight: 500;
        }
        
        /* Invalid input styling */
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        
        .error-message {
            color: #dc2626;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        /* Logo styling */
        .company-logo {
            max-height: 80px;
            width: auto;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <header class="mb-6 flex flex-col items-center">
            <!-- Added company logo -->
            <img src="https://lh3.googleusercontent.com/d/162Uax_OrRhqYepfLk-CnaUP5NDlpQ2YW" alt="LUCKYGLASS Logo" class="company-logo mb-2">
            <h1 class="text-3xl font-bold text-center text-blue-800">LUCKY Connect</h1>
            <h2 class="text-xl font-semibold text-center text-blue-700 mt-1">B2B E-Order System</h2>
        </header>

        <!-- Search Bar -->
        <div class="relative mb-6 max-w-2xl mx-auto">
            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden bg-white">
                <input type="text" id="search-input" class="flex-grow px-4 py-2 focus:outline-none" placeholder="Search by product code, name or series...">
                <button id="search-button" class="bg-blue-600 text-white px-4 py-2 hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="search-results" class="search-results hidden"></div>
        </div>

        <!-- ========================= -->
<!-- ðŸŸ¥ Left Panel (Filters) -->
<!-- ========================= -->

        <div class="three-column-layout grid grid-cols-1 lg:grid-cols-[200px_1fr_260px] gap-6">
            <!-- Left Sidebar -->
            <div class="sidebar bg-white p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">Product Filters</h3>
                
                <!-- Product Type Filter -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Product Type</h4>
                    <div id="product-type-filters" class="space-y-2">
                        <button class="filter-btn w-full text-left px-3 py-2 rounded-md text-sm active bg-blue-100" data-filter="all">
                            All Products
                        </button>
                        <!-- Product type filters will be added here dynamically -->
                        <div class="animate-pulse">
                            <div class="h-8 bg-gray-200 rounded mb-2"></div>
                            <div class="h-8 bg-gray-200 rounded mb-2"></div>
                            <div class="h-8 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ============================ -->
<!-- ðŸŸ© Middle Panel (Products) -->
<!-- ============================ -->

            <div class="main-content">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="products-container">
                    <!-- Products will be loaded here -->
                    <div class="animate-pulse bg-white p-4 rounded-lg shadow-md">
                        <div class="flex">
                            <div class="bg-gray-300 h-[2.5cm] w-[2.5cm] rounded"></div>
                            <div class="ml-3 flex-1">
                                <div class="bg-gray-300 h-5 w-3/4 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-1/2 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-2/3 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-1/2 mb-3 rounded"></div>
                                <div class="bg-gray-300 h-8 w-24 rounded"></div>
                            </div>
                        </div>
                    </div>
                    <div class="animate-pulse bg-white p-4 rounded-lg shadow-md">
                        <div class="flex">
                            <div class="bg-gray-300 h-[2.5cm] w-[2.5cm] rounded"></div>
                            <div class="ml-3 flex-1">
                                <div class="bg-gray-300 h-5 w-3/4 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-1/2 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-2/3 mb-2 rounded"></div>
                                <div class="bg-gray-300 h-4 w-1/2 mb-3 rounded"></div>
                                <div class="bg-gray-300 h-8 w-24 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination controls -->
                <div id="pagination-container" class="flex justify-center mt-8 mb-8 hidden">
                    <div class="inline-flex rounded-md shadow-sm" role="group" aria-label="Pagination">
                        <button id="prev-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-50 focus:z-10 focus:outline-none">
                            <i class="fas fa-chevron-left mr-1"></i> Previous
                        </button>
                        <div id="page-numbers" class="flex">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button id="next-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-50 focus:z-10 focus:outline-none">
                            Next <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ============================ -->
<!-- ðŸŸ¦ Right Panel (Order Summary) -->
<!-- ============================ -->

            <div class="order-summary bg-white p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">Order Summary</h3>
                
                <!-- Container Selection -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Select Container</h4>
                    <div id="container-buttons" class="grid grid-cols-3 gap-2"></div>
                </div>
                
                <!-- Container Fill Visualization -->
                <div class="mb-4 p-3 bg-gray-50 rounded-md">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-600">Volume (CBM)</span>
                        <span id="cbm-percentage" class="text-xs font-medium text-blue-600">0%</span>
                    </div>
                    <div class="progress-bar mb-2">
                        <div id="cbm-progress" class="progress-fill cbm-fill" style="width: 0%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-600">Weight (G.W.)</span>
                        <span id="weight-percentage" class="text-xs font-medium text-green-600">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="weight-progress" class="progress-fill weight-fill" style="width: 0%"></div>
                    </div>
                   
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span id="total-cbm">Total: 0 CBM</span>
                        <span id="total-weight">Total: 0 kgs</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span id="total-assorted-items">Total Assorted Items: 0</span>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Order Items</h4>
                    <div id="order-items-container" class="max-h-160 overflow-y-auto custom-scrollbar" style="max-height: 40rem;">
                        <p id="empty-cart-message" class="text-gray-500 italic text-sm">Your order is empty. Add some products to place an order.</p>
                        <div id="order-items-list" class="hidden space-y-2">
                            <!-- Order items will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Checkout Form -->
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Checkout</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="customer-name" class="block text-xs text-gray-500 mb-1">Company Name</label>
                            <input type="text" id="customer-name" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter company name">
                        </div>
                        <div>
                            <label for="customer-email" class="block text-xs text-gray-500 mb-1">Email</label>
                            <input type="email" id="customer-email" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter email address">
                            <div id="email-error" class="error-message hidden">Please enter a valid email address</div>
                        </div>
                        <div>
                            <label for="po-number" class="block text-xs text-gray-500 mb-1">Purchase Order Number</label>
                            <input type="text" id="po-number" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter PO number">
                        </div>
                        <!-- Added Remarks field -->
                        <div>
                            <label for="remarks" class="block text-xs text-gray-500 mb-1">Remarks</label>
                            <textarea id="remarks" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Enter any additional information or special requests" rows="3"></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button id="submit-order" class="submit-order-btn flex-1 text-white py-2 rounded-md text-sm opacity-50 cursor-not-allowed" disabled>
                                Submit Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const cart = [];

        // Your Google Sheet IDs
        const productsSheetId = '1sPtFYvm3b_SiFGsHnhfbjNVHiDCApWO5WjwwZEIP89Y';
        const ordersSheetId = '1qvAdtDk3pNPhjVxqBFf17STaz2SZp_HFtpz1VQEGCrE';

        // Your deployed Google Apps Script web app URLs
        const scriptURL = 'https://script.google.com/macros/s/AKfycbw4xIJ1FL0Ng_B44O1LMJhcwFgTi8HvO71JABpnFmtG9iw0HeNN_Bnrv9qVTT1CzYwZ/exec';
        const orderSubmitURL = "https://script.google.com/macros/s/AKfycbzAZsM-pMAwQZEXp6ENte096WlAQKa0osEixGYsdRl47_Y3F3IAHL-ShxoTsb6h_FvE/exec";
        
        let products = [];
        let filteredProducts = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let productTypes = [];
        let currentFilter = 'all';
        let containerSettings = {
            '20FT': { type: '20FT', maxCBM: 29.5, maxWeight: 21000 },
            '40FT': { type: '40FT', maxCBM: 58.5, maxWeight: 24000 },
            '40HQ': { type: '40HQ', maxCBM: 69.5, maxWeight: 26500 }
        };
        let selectedContainer = containerSettings['40HQ'];
        
        // ==========================
// ðŸŸ¥ Left Panel JS Elements
// ==========================
        const productsContainer = document.getElementById('products-container');
        const orderItemsList = document.getElementById('order-items-list');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const customerNameInput = document.getElementById('customer-name');
        const customerEmailInput = document.getElementById('customer-email');
        const emailErrorMessage = document.getElementById('email-error');
        const poNumberInput = document.getElementById('po-number');
        const remarksInput = document.getElementById('remarks'); // New remarks field
        const submitOrderButton = document.getElementById('submit-order');
        const loadingElement = document.getElementById('loading');
        const paginationContainer = document.getElementById('pagination-container');
        const pageNumbersContainer = document.getElementById('page-numbers');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const productTypeFilters = document.getElementById('product-type-filters');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResults = document.getElementById('search-results');
        const cbmProgress = document.getElementById('cbm-progress');
        const weightProgress = document.getElementById('weight-progress');
        const cbmPercentage = document.getElementById('cbm-percentage');
        const weightPercentage = document.getElementById('weight-percentage');
        const totalCBM = document.getElementById('total-cbm');
        const totalWeight = document.getElementById('total-weight');
        const totalAssortedItems = document.getElementById('total-assorted-items');
        
        // Helper function to format numbers with commas and decimal places
        function formatNumber(number, decimals = 0) {
            if (number === undefined || number === null) return '0';
            return parseFloat(number).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        // Email validation function
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Event listeners
        customerNameInput.addEventListener('input', validateForm);
        customerEmailInput.addEventListener('input', validateEmail);
        poNumberInput.addEventListener('input', validateForm);
        remarksInput.addEventListener('input', validateForm); // Added event listener for remarks
        submitOrderButton.addEventListener('click', submitOrder);
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderProductsForCurrentPage();
                updatePaginationControls();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        nextPageButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderProductsForCurrentPage();
                updatePaginationControls();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        
        // Validate email format
        function validateEmail() {
            const email = customerEmailInput.value.trim();
            
            if (email === '') {
                // Empty email is allowed (not required)
                customerEmailInput.classList.remove('input-error');
                emailErrorMessage.classList.add('hidden');
                validateForm();
                return true;
            }
            
            if (!isValidEmail(email)) {
                customerEmailInput.classList.add('input-error');
                emailErrorMessage.classList.remove('hidden');
                validateForm();
                return false;
            } else {
                customerEmailInput.classList.remove('input-error');
                emailErrorMessage.classList.add('hidden');
                validateForm();
                return true;
            }
        }
        
        // ==========================
// ðŸŸ¥ Left Panel Search JS
// ==========================
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        searchButton.addEventListener('click', performSearch);
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
        
        // Container selection
        document.querySelectorAll('.container-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                document.querySelectorAll('.container-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Add active class to clicked button
                btn.classList.add('active');
                
                // Update selected container
                const containerType = btn.dataset.container;
                const maxCBM = parseFloat(btn.dataset.cbm);
                const maxWeight = parseFloat(btn.dataset.weight);
                
                selectedContainer = {
                    type: containerType,
                    maxCBM: maxCBM,
                    maxWeight: maxWeight
                };
                
                console.log("Selected container:", selectedContainer);
                
                // ============================
// ðŸŸ¦ Right Panel Container Visualization
// ============================
                updateContainerVisualization();
            });
        });
        
        // Initialize the app
        window.onload = function() {
            fetchProducts();
            fetchContainerSettings(); // Added function to fetch container settings
        };
        
        // JSONP callback function
        window.handleProductsResponse = function(data) {
            console.log("Products data received:", data);
            
            if (Array.isArray(data)) {
                products = data;
                
                // Sort products by product code
                products.sort((a, b) => a.productCode.localeCompare(b.productCode));
                
                // Extract product types
                extractProductTypes();
                
                // Initialize filtered products
                filteredProducts = [...products];
                
                renderProductsForCurrentPage();
                setupPagination();
                renderProductTypeFilters();
                
            } else {
                console.error('Invalid data format received:', data);
                // Use sample data as fallback
                products = generateSampleProducts(100);
                products.sort((a, b) => a.productCode.localeCompare(b.productCode));
                
                // Extract product types
                extractProductTypes();
                
                // Initialize filtered products
                filteredProducts = [...products];
                
                renderProductsForCurrentPage();
                setupPagination();
                renderProductTypeFilters();
                showSweetAlert('warning', 'Using sample data', 'Could not load products from Google Sheet. Using sample data instead.');
            }
            hideLoading();
        };
        
        // JSONP callback function for container settings
        window.handleContainerSettingsResponse = function(data) {
            console.log("Container settings received:", data);
            
            if (Array.isArray(data) && data.length > 0) {
                // Update container settings from the data
                data.forEach(container => {
                    if (container.type && containerSettings[container.type]) {
                        containerSettings[container.type].maxCBM = parseFloat(container.maxCBM) || containerSettings[container.type].maxCBM;
                        containerSettings[container.type].maxWeight = parseFloat(container.maxWeight) || containerSettings[container.type].maxWeight;
                    }
                });
                
                // Update selected container
                const selectedType = document.querySelector('.container-btn.active').dataset.container;
                selectedContainer = containerSettings[selectedType];
                
                // Update container buttons with the values from settings
                updateContainerButtons();
                
                console.log("Updated container settings:", containerSettings);
            } else {
                console.error('Invalid container settings format received:', data);
            }
        };
        
        // Fetch container settings from the ContainerType sheet
        function fetchContainerSettings() {
            console.log("Fetching container settings...");
            
            // Remove any existing script tags
            const oldScript = document.getElementById('jsonp-container-script');
            if (oldScript) {
                document.body.removeChild(oldScript);
            }
            
            // Create a new script tag for JSONP
            const script = document.createElement('script');
            script.id = 'jsonp-container-script';
            script.src = `${scriptURL}?action=getContainerSettings&callback=handleContainerSettingsResponse`;
            document.body.appendChild(script);
            
            // Set a timeout in case the script fails to load
            setTimeout(() => {
                console.log("Using default container settings");
            }, 5000);
        }
        
        // Update container buttons with the values from settings
        function updateContainerButtons() {
            document.querySelectorAll('.container-btn').forEach(btn => {
                const containerType = btn.dataset.container;
                if (containerSettings[containerType]) {
                    btn.dataset.cbm = containerSettings[containerType].maxCBM;
                    btn.dataset.weight = containerSettings[containerType].maxWeight;
                    console.log(`Updated ${containerType} button:`, {
                        cbm: btn.dataset.cbm,
                        weight: btn.dataset.weight
                    });
                }
            });
        }
        
        // Extract unique product types from products
        function extractProductTypes() {
            const types = new Set();
            products.forEach(product => {
                if (product.type) {
                    types.add(product.type);
                }
            });
            productTypes = Array.from(types).sort();
        }
        
        // ===============================
// ðŸŸ¥ Left Panel Filter Renderer
// ===============================
        function renderProductTypeFilters() {
            productTypeFilters.innerHTML = `
                <button class="filter-btn w-full text-left px-3 py-2 rounded-md text-sm active bg-blue-100" data-filter="all">
                    All Products
                </button>
            `;
            
            productTypes.forEach(type => {
                const button = document.createElement('button');
                button.className = 'filter-btn w-full text-left px-3 py-2 rounded-md text-sm';
                button.dataset.filter = type;
                button.textContent = type;
                
                button.addEventListener('click', () => {
                    // Update active filter
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-blue-100');
                    });
                    button.classList.add('active', 'bg-blue-100');
                    
                    // Apply filter
                    currentFilter = type;
                    applyFilters();
                });
                
                productTypeFilters.appendChild(button);
            });
            
            // Add event listener to "All Products" button
            const allProductsBtn = productTypeFilters.querySelector('.filter-btn[data-filter="all"]');
            allProductsBtn.addEventListener('click', () => {
                // Update active filter
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-100');
                });
                allProductsBtn.classList.add('active', 'bg-blue-100');
                
                // Apply filter
                currentFilter = 'all';
                applyFilters();
            });
        }
        
        // Apply filters to products
        function applyFilters() {
            if (currentFilter === 'all') {
                filteredProducts = [...products];
            } else {
                filteredProducts = products.filter(product => product.type === currentFilter);
            }
            
            currentPage = 1;
            renderProductsForCurrentPage();
            setupPagination();
        }
        
        // Handle search input
        function handleSearchInput() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            const matchingProducts = products.filter(product => 
                product.productCode.toLowerCase().includes(query) || 
                (product.seriesName && product.seriesName.toLowerCase().includes(query)) ||
                (product.type && product.type.toLowerCase().includes(query))
            ).slice(0, 10); // Limit to 10 results
            
            if (matchingProducts.length > 0) {
                renderSearchResults(matchingProducts);
                searchResults.classList.remove('hidden');
            } else {
                searchResults.classList.add('hidden');
            }
        }
        
        // Render search results
        function renderSearchResults(results) {
            searchResults.innerHTML = '';
            
            results.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="font-medium">${product.productCode}</div>
                    <div class="text-xs text-gray-500">${product.seriesName || ''}</div>
                    <div class="text-xs text-gray-500">${product.packing || ''}</div>
                `;
                
                resultItem.addEventListener('click', () => {
                    // Find the product in the main list and scroll to it
                    searchInput.value = product.productCode;
                    searchResults.classList.add('hidden');
                    
                    // Filter to show only this product
                    filteredProducts = [product];
                    currentPage = 1;
                    renderProductsForCurrentPage();
                    setupPagination();
                });
                
                searchResults.appendChild(resultItem);
            });
        }
        
        // Perform search
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length < 2) {
                return;
            }
            
            filteredProducts = products.filter(product => 
                product.productCode.toLowerCase().includes(query) || 
                (product.seriesName && product.seriesName.toLowerCase().includes(query)) ||
                (product.type && product.type.toLowerCase().includes(query))
            );
            
            currentPage = 1;
            renderProductsForCurrentPage();
            setupPagination();
            searchResults.classList.add('hidden');
            
            // Reset filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100');
            });
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active', 'bg-blue-100');
        }
        
        // Fetch products using JSONP
        function fetchProducts() {
            showLoading();
            console.log("Fetching products from:", scriptURL);
            
            // Remove any existing script tags
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) {
                document.body.removeChild(oldScript);
            }
            
            // Create a new script tag for JSONP
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = `${scriptURL}?action=getProducts&callback=handleProductsResponse`;
            document.body.appendChild(script);
            
            // Set a timeout in case the script fails to load
            setTimeout(() => {
                if (products.length === 0) {
                    console.error('Timeout fetching products');
                    products = generateSampleProducts(100);
                    products.sort((a, b) => a.productCode.localeCompare(b.productCode));
                    
                    // Extract product types
                    extractProductTypes();
                    
                    // Initialize filtered products
                    filteredProducts = [...products];
                    
                    renderProductsForCurrentPage();
                    setupPagination();
                    renderProductTypeFilters();
                    hideLoading();
                    showSweetAlert('warning', 'Using sample data', 'Could not load products from Google Sheet. Using sample data instead.');
                }
            }, 10000);
        }
        
        // Generate sample products for testing
        function generateSampleProducts(count) {
            const sampleTypes = ['Tumbler', 'Bowl', 'Mug & Cup', 'Shot Glass', 'Saucer & Coaster', 'Candle Holder', 'Printed & Frosted Glass'];
            const sampleSeries = ['Classic', 'Modern', 'Vintage', 'Premium', 'Economy', 'Luxury', 'Standard'];
            const sampleProducts = [];
            
            for (let i = 1; i <= count; i++) {
                const productCode = `LG-${(10000 + i).toString()}`;
                const type = sampleTypes[Math.floor(Math.random() * sampleTypes.length)];
                const seriesName = sampleSeries[Math.floor(Math.random() * sampleSeries.length)];
                const piecesPerCarton = Math.floor(Math.random() * 24) + 6;
                const packing = `${piecesPerCarton} x ${Math.floor(Math.random() * 1000) + 250}ml`;
                const grossWeight = (Math.random() * 20 + 5).toFixed(2); // Changed to 2 decimal places
                const cbm = (Math.random() * 0.05 + 0.01).toFixed(4);
                
                sampleProducts.push({
                    productCode: productCode,
                    packing: packing,
                    type: type,
                    seriesName: seriesName,
                    grossWeight: grossWeight,
                    cbm: cbm,
                    piecesPerCarton: piecesPerCarton,
                    imageUrl: 'https://via.placeholder.com/250?text=Sample+Product'
                });
                
                // Create some products with same code but different packing
                if (i % 10 === 0) {
                    const altPiecesPerCarton = Math.floor(Math.random() * 24) + 6;
                    sampleProducts.push({
                        productCode: productCode,
                        packing: `${altPiecesPerCarton} x ${Math.floor(Math.random() * 1000) + 250}ml`,
                        type: type,
                        seriesName: seriesName,
                        grossWeight: (Math.random() * 20 + 5).toFixed(2), // Changed to 2 decimal places
                        cbm: (Math.random() * 0.05 + 0.01).toFixed(4),
                        piecesPerCarton: altPiecesPerCarton,
                        imageUrl: 'https://via.placeholder.com/250?text=Sample+Product'
                    });
                }
            }
            return sampleProducts;
        }
        
        // Setup pagination controls
        function setupPagination() {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.classList.add('hidden');
                return;
            }
            
            paginationContainer.classList.remove('hidden');
            updatePaginationControls();
        }
        
        // Update pagination controls based on current page
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            
            // Update prev/next button states
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
            
            if (prevPageButton.disabled) {
                prevPageButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevPageButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextPageButton.disabled) {
                nextPageButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextPageButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Generate page number buttons
            pageNumbersContainer.innerHTML = '';
            
            // Determine which page numbers to show
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // Add first page button if not included in the range
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }
            
            // Add page number buttons
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // Add last page button if not included in the range
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
        }
        
        // Add a page number button to the pagination controls
        function addPageButton(pageNum) {
            const button = document.createElement('button');
            button.className = `pagination-btn px-4 py-2 text-sm font-medium border-t border-b border-gray-300 ${currentPage === pageNum ? 'active' : ''}`;
            button.textContent = pageNum;
            
            button.addEventListener('click', () => {
                if (currentPage !== pageNum) {
                    currentPage = pageNum;
                    renderProductsForCurrentPage();
                    updatePaginationControls();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            pageNumbersContainer.appendChild(button);
        }
        
        // Add ellipsis to pagination controls
        function addEllipsis() {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-4 py-2 text-sm font-medium border-t border-b border-gray-300 bg-white';
            ellipsis.textContent = '...';
            pageNumbersContainer.appendChild(ellipsis);
        }
        
        // Render products for the current page
        function renderProductsForCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
            const currentPageProducts = filteredProducts.slice(startIndex, endIndex);
            
            renderProducts(currentPageProducts);
        }
        
        // ============================
// ðŸŸ© Middle Panel Product Renderer
// ============================
        function renderProducts(productsToRender) {
            productsContainer.innerHTML = '';
            
            if (productsToRender.length === 0) {
                const noProducts = document.createElement('div');
                noProducts.className = 'col-span-full text-center py-8';
                noProducts.innerHTML = '<p class="text-gray-500">No products found.</p>';
                productsContainer.appendChild(noProducts);
                return;
            }
            
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-white p-3 rounded-lg shadow-md';
                
                // Fix image URL if needed
                let imageUrl = product.imageUrl;
                if (!imageUrl) {
                    imageUrl = 'https://via.placeholder.com/250?text=No+Image';
                } else if (imageUrl.includes('/view?usp=drive_link')) {
                    // Convert Google Drive view link to direct image link
                    imageUrl = imageUrl.replace('/view?usp=drive_link', '');
                    
                    // If it's a Google Drive file ID, convert to direct link format
                    if (imageUrl.includes('drive.google.com/file/d/')) {
                        const fileIdMatch = imageUrl.match(/\/d\/([^\/]+)/);
                        if (fileIdMatch && fileIdMatch[1]) {
                            const fileId = fileIdMatch[1];
                            imageUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                        }
                    }
                }
                
                // Calculate total pieces based on quantity
                const piecesPerCarton = parseInt(product.piecesPerCarton) || 0;
                
                productCard.innerHTML = `
                    <div class="flex">
                        <div class="bg-blue-50 p-1 rounded-lg">
                            <img src="${imageUrl}" alt="${product.productCode}" class="product-image rounded-lg" onerror="this.src='https://via.placeholder.com/250?text=Image+Not+Found'">
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="text-sm font-semibold text-blue-700">${product.productCode}</h3>
                            <p class="series-name text-xs mb-1"><strong>${product.seriesName || ''}
                            <span class="text-black text-xs mb-1">-- Packing: ${product.packing}</span></strong></p>
                            <p class="text-gray-600 text-xs mb-1"><span class="font-medium">Gross Weight:</span> ${formatNumber(product.grossWeight, 2)} Kgs/Carton</p>
                            <p class="text-gray-600 text-xs mb-2"><span class="font-medium">CBM/Carton:</span> ${formatNumber(product.cbm, 4)}</p>
                            <div class="flex items-center">
                                <div class="flex flex-col">
                                    <div class="flex items-center">
                                        <input type="number" min="1" value="1" class="quantity-input w-12 px-1 py-1 border border-gray-300 rounded-lg text-center text-sm" 
                                            aria-label="Quantity for ${product.productCode}" data-pieces-per-carton="${piecesPerCarton}">
                                        <span class="text-xs text-gray-500 ml-1 mr-2">cartons</span>
                                        <button class="add-to-cart-btn text-white px-2 py-1 rounded-lg transition-colors flex items-center text-xs">
                                            <i class="fas fa-shopping-cart mr-1"></i> Add to Order
                                        </button>
                                    </div>
                                    <div class="total-pieces text-xs text-gray-500 mt-1">Total: ${piecesPerCarton} pieces</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const quantityInput = productCard.querySelector('.quantity-input');
                const totalPiecesElement = productCard.querySelector('.total-pieces');
                const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
                
                // Update total pieces when quantity changes
                quantityInput.addEventListener('input', () => {
                    const quantity = parseInt(quantityInput.value) || 0;
                    const piecesPerCarton = parseInt(quantityInput.dataset.piecesPerCarton) || 0;
                    const totalPieces = quantity * piecesPerCarton;
                    totalPiecesElement.textContent = `Total: ${formatNumber(totalPieces)} pieces`;
                });
                
                addToCartBtn.addEventListener('click', () => {
                    const quantity = parseInt(quantityInput.value);
                    
                    if (quantity > 0) {
                        addToCart(product, quantity);
                        quantityInput.value = 1;
                        // Update total pieces display after resetting quantity
                        totalPiecesElement.textContent = `Total: ${piecesPerCarton} pieces`;
                        showSweetAlert('success', 'Added to Order', `Added ${quantity} carton(s) of ${product.productCode} to order`);
                    } else {
                        showSweetAlert('error', 'Invalid Quantity', 'Please enter a valid quantity');
                    }
                });
                
                productsContainer.appendChild(productCard);
            });
        }
        
        // Generate a unique ID for cart items based on product code AND packing
        function getCartItemId(product) {
            return `${product.productCode}_${product.packing}`;
        }
        
        // Add product to cart
        function addToCart(product, quantity) {
            const cartItemId = getCartItemId(product);
            const existingItemIndex = cart.findIndex(item => getCartItemId(item) === cartItemId);
            
            if (existingItemIndex !== -1) {
                cart[existingItemIndex].quantity += quantity;
            } else {
                cart.push({
                    productCode: product.productCode,
                    seriesName: product.seriesName || '',
                    packing: product.packing,
                    quantity: quantity,
                    grossWeight: parseFloat(product.grossWeight) || 0,
                    cbm: parseFloat(product.cbm) || 0,
                    piecesPerCarton: parseInt(product.piecesPerCarton) || 0
                });
            }
            
            updateOrderSummary();
        }
        
        // Remove item from cart
        function removeFromCart(cartItemId) {
            const index = cart.findIndex(item => getCartItemId(item) === cartItemId);
            if (index !== -1) {
                const removedItem = cart[index];
                cart.splice(index, 1);
                updateOrderSummary();
                showSweetAlert('info', 'Item Removed', `Removed ${removedItem.productCode} from order`);
            }
        }
        
        // Update quantity of item in cart
        function updateCartItemQuantity(cartItemId, newQuantity) {
            const index = cart.findIndex(item => getCartItemId(item) === cartItemId);
            if (index !== -1 && newQuantity > 0) {
                cart[index].quantity = newQuantity;
                updateOrderSummary();
            }
        }
        
        // Count unique product codes in cart
        function countUniqueProductCodes() {
            const uniqueProductCodes = new Set();
            cart.forEach(item => {
                uniqueProductCodes.add(item.productCode);
            });
            return uniqueProductCodes.size;
        }
        
        // ============================
// ðŸŸ¦ Right Panel Order Summary
// ============================
        function updateOrderSummary() {
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                orderItemsList.classList.add('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                orderItemsList.classList.remove('hidden');
                
                orderItemsList.innerHTML = '';
                
                cart.forEach(item => {
                    const itemTotalCBM = (item.cbm * item.quantity);
                    const itemTotalWeight = (item.grossWeight * item.quantity);
                    const totalPieces = item.piecesPerCarton * item.quantity;
                    const cartItemId = getCartItemId(item);
                    
                    const orderItem = document.createElement('div');
                    orderItem.className = 'bg-gray-50 p-2 rounded-md text-sm';
                    
                    orderItem.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium">${item.productCode}</span>
                            <div class="flex space-x-1">
                                <button class="edit-qty-btn text-blue-600 hover:text-blue-800" aria-label="Edit quantity">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="remove-item-btn text-red-600 hover:text-red-800" aria-label="Remove item">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="series-name text-xs mb-1">${item.seriesName}
                        <span class="text-black text-xs mb-1">-- Packing: ${item.packing}</span></div>
                        <div class="flex justify-between text-xs mb-1">
                            <span><b>Qty: ${formatNumber(item.quantity)} cartons</b></span>
                            <span>Total: ${formatNumber(totalPieces)} pcs</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span>CBM: ${formatNumber(itemTotalCBM, 4)}</span>
                            <span>G.W.: ${formatNumber(itemTotalWeight, 2)} kgs</span>
                        </div>
                    `;
                    
                    const editQtyBtn = orderItem.querySelector('.edit-qty-btn');
                    const removeItemBtn = orderItem.querySelector('.remove-item-btn');
                    
                    editQtyBtn.addEventListener('click', () => {
                        Swal.fire({
                            title: 'Update Quantity',
                            input: 'number',
                            inputLabel: `Enter new quantity for ${item.productCode}`,
                            inputValue: item.quantity,
                            showCancelButton: true,
                            inputValidator: (value) => {
                                if (!value || parseInt(value) < 1) {
                                    return 'Please enter a valid quantity (minimum 1)';
                                }
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const newQuantity = parseInt(result.value);
                                updateCartItemQuantity(cartItemId, newQuantity);
                            }
                        });
                    });
                    
                    removeItemBtn.addEventListener('click', () => {
                        removeFromCart(cartItemId);
                    });
                    
                    orderItemsList.appendChild(orderItem);
                });
            }
            
            updateContainerVisualization();
            validateForm();
        }
        
        // ============================
// ðŸŸ¦ Right Panel Container Visualization
// ============================
        function updateContainerVisualization() {
            // Calculate totals
            let totalCBMValue = 0;
            let totalWeightValue = 0;
            
            cart.forEach(item => {
                totalCBMValue += item.cbm * item.quantity;
                totalWeightValue += item.grossWeight * item.quantity;
            });
            
            // Calculate percentages
            const cbmPercentageValue = (totalCBMValue / selectedContainer.maxCBM) * 100;
            const weightPercentageValue = (totalWeightValue / selectedContainer.maxWeight) * 100;
            
            // Count unique product codes
            const uniqueProductCount = countUniqueProductCodes();
            
            console.log("Container visualization:", {
                totalCBM: totalCBMValue,
                totalWeight: totalWeightValue,
                maxCBM: selectedContainer.maxCBM,
                maxWeight: selectedContainer.maxWeight,
                cbmPercentage: cbmPercentageValue,
                weightPercentage: weightPercentageValue,
                uniqueProductCount: uniqueProductCount
            });
            
            // Update progress bars
            cbmProgress.style.width = `${Math.min(cbmPercentageValue, 100)}%`;
            weightProgress.style.width = `${Math.min(weightPercentageValue, 100)}%`;
            
            // Update percentage text
            cbmPercentage.textContent = `${cbmPercentageValue.toFixed(1)}%`;
            weightPercentage.textContent = `${weightPercentageValue.toFixed(1)}%`;
            
            // Update totals text
            totalCBM.textContent = `Total: ${formatNumber(totalCBMValue, 4)} CBM`;
            totalWeight.textContent = `Total: ${formatNumber(totalWeightValue, 2)} kgs`;
            totalAssortedItems.textContent = `Total Assorted Items: ${uniqueProductCount}`;
            
            // Change color if over capacity
            if (cbmPercentageValue > 100) {
                cbmProgress.classList.add('bg-red-500');
                cbmPercentage.classList.add('text-red-600');
            } else {
                cbmProgress.classList.remove('bg-red-500');
                cbmPercentage.classList.remove('text-red-600');
            }
            
            if (weightPercentageValue > 100) {
                weightProgress.classList.add('bg-red-500');
                weightPercentage.classList.add('text-red-600');
            } else {
                weightProgress.classList.remove('bg-red-500');
                weightPercentage.classList.remove('text-red-600');
            }
        }
        
        // ============================
// ðŸŸ¦ Right Panel Form Validation
// ============================
        function validateForm() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim();
            const poNumber = poNumberInput.value.trim();
            
            // Check email validity if provided
            const isEmailValid = customerEmail === '' || isValidEmail(customerEmail);
            
            const isValid = customerName !== '' && poNumber !== '' && cart.length > 0 && isEmailValid;
            
            if (isValid) {
                submitOrderButton.disabled = false;
                submitOrderButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitOrderButton.disabled = true;
                submitOrderButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // ============================
// ðŸŸ¦ Right Panel Order Submission
// ============================
        function submitOrder() {
            const customerName = customerNameInput.value.trim();
            const customerEmail = customerEmailInput.value.trim();
            const poNumber = poNumberInput.value.trim(); // Keep as string to preserve leading zeros
            const remarks = remarksInput.value.trim(); // Get remarks value
            
            if (customerName === '') {
                showSweetAlert('error', 'Missing Information', 'Please enter company name');
                return;
            }
            
            if (poNumber === '') {
                showSweetAlert('error', 'Missing Information', 'Please enter purchase order number');
                return;
            }
            
            if (customerEmail !== '' && !isValidEmail(customerEmail)) {
                showSweetAlert('error', 'Invalid Email', 'Please enter a valid email address');
                return;
            }
            
            if (cart.length === 0) {
                showSweetAlert('error', 'Empty Order', 'Your order is empty');
                return;
            }
            
            // Show loading state with SweetAlert
            Swal.fire({
                title: 'Submitting Order',
                html: 'Please wait while we process your order...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Create a timestamp for the order
            const timestamp = new Date().toISOString();
            
            // Prepare order data
            const orderItems = [];
            
            cart.forEach(item => {
                orderItems.push({
                    productCode: item.productCode,
                    packing: item.packing,
                    quantity: item.quantity,
                    customerName: customerName,
                    customerEmail: customerEmail,
                    poNumber: poNumber, // This will preserve leading zeros as a string
                    remarks: remarks, // Include remarks in the order data
                    timestamp: timestamp,
                    containerSize: selectedContainer.type
                });
            });
            
            // Create the order data object
            const orderData = {
                items: orderItems,
                poNumberIsString: true // Add a flag to indicate PO number should be treated as string
            };
            
            console.log("Order data:", orderData);
            
            // Convert order data to FormData
            const formData = new FormData();
            formData.append('data', JSON.stringify(orderData));
            formData.append('poNumberIsString', 'true'); // Add as form field too
            
            // Try multiple methods to ensure data is submitted
            trySubmitWithFormData(formData, orderData);
        }
        
        // Try to submit with FormData (Method 1)
        function trySubmitWithFormData(formData, orderData) {
            console.log("Trying to submit with FormData (Method 1)...");
            
            fetch(orderSubmitURL, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                console.log('FormData submission response:', response);
                handleSuccessfulSubmission();
            })
            .catch(error => {
                console.error("FormData submission error:", error);
                // Try XMLHttpRequest as fallback (Method 4)
                trySubmitWithXHR(formData, orderData);
            });
        }
        
        // Try to submit with XMLHttpRequest (Method 4)
        function trySubmitWithXHR(formData, orderData) {
            console.log("Trying to submit with XMLHttpRequest (Method 4)...");
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', orderSubmitURL, true);
            
            xhr.onload = function() {
                console.log('XMLHttpRequest response:', xhr.responseText);
                handleSuccessfulSubmission();
            };
            
            xhr.onerror = function() {
                console.error("XMLHttpRequest error");
                // Try direct JSON as last resort (Method 2)
                trySubmitWithDirectJSON(orderData);
            };
            
            xhr.send(formData);
        }
        
        // Try to submit with direct JSON (Method 2)
        function trySubmitWithDirectJSON(orderData) {
            console.log("Trying to submit with direct JSON (Method 2)...");
            
            fetch(orderSubmitURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData),
                mode: 'no-cors'
            })
            .then(response => {
                console.log('Direct JSON submission response:', response);
                handleSuccessfulSubmission();
            })
            .catch(error => {
                console.error("Direct JSON submission error:", error);
                // All methods failed, show error
                Swal.fire({
                    title: 'Submission Error',
                    text: 'Could not submit your order. Please try again or contact support.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        }
        
        // Handle successful submission
        function handleSuccessfulSubmission() {
            // Clear cart and form
            cart.length = 0;
            customerNameInput.value = '';
            customerEmailInput.value = '';
            poNumberInput.value = '';
            remarksInput.value = ''; // Clear remarks field
            updateOrderSummary();
            
            Swal.fire({
                title: 'Order Submitted!',
                text: 'Your order has been successfully submitted.',
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }
        
        // Show loading spinner
        function showLoading() {
            loadingElement.style.display = 'flex';
        }
        
        // Hide loading spinner
        function hideLoading() {
            loadingElement.style.display = 'none';
        }
        
        // Show SweetAlert
        function showSweetAlert(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                confirmButtonColor: '#3b82f6'
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96375c7bd1f62db0',t:'MTc1MzIzMzY5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>
  function fetchDynamicContainerButtons() {
    const script = document.createElement('script');
    script.src = `${scriptURL}?action=getContainerTypes&callback=handleDynamicContainers`;
    script.id = 'dynamic-container-script';
    document.body.appendChild(script);
  }

  function handleDynamicContainers(data) {
    const containerDiv = document.getElementById('container-buttons');
    containerDiv.innerHTML = '';

    if (!Array.isArray(data)) {
      console.error('Invalid container data:', data);
      return;
    }

    data.forEach(row => {
      const containerType = row['Container Type'] || row['type'] || row['container'];
      const cbm = parseFloat(row['CBM / Container'] || row['cbm']) || 0;
      const weight = parseFloat(row['Gross Weight / Container (Kgs)'] || row['weight']) || 0;

      if (!containerType) return;

      const btn = document.createElement('button');
      btn.className = 'container-btn px-2 py-1 text-xs border border-gray-300 rounded-md hover:bg-blue-50 transition-colors';
      btn.dataset.container = containerType;
      btn.dataset.cbm = cbm;
      btn.dataset.weight = weight;
      btn.innerHTML = `<strong>${containerType}</strong>`;

      btn.addEventListener('click', () => {
        document.querySelectorAll('.container-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        selectedContainer = {
          type: containerType,
          maxCBM: cbm,
          maxWeight: weight
        };

        updateContainerVisualization();
      });

      containerDiv.appendChild(btn);
    });

    const firstBtn = containerDiv.querySelector('.container-btn');
    if (firstBtn) firstBtn.click();
  }

  const originalOnload = window.onload;
  window.onload = function () {
    if (originalOnload) originalOnload();
    fetchDynamicContainerButtons();
  };

    document.getElementById("companyName").textContent = sessionStorage.getItem("company") || "Unknown";

</script>
</body>

<!-- URL for ShowProducts
https://script.google.com/macros/s/AKfycbwQ_lwiNQhJsMUkktZN4CUyEh0LlQOJPzPjatcdfZ6r5uvKnnLE9sibejs2OnDccFU/exec
-->

<!-- URL for GetOrders
https://script.google.com/macros/s/AKfycbzz5FqcEGblUAiswKTaZu4pZfXJ8BxwwOtVe4K-cAxMWBk9MwSbTtvOhKWrlI1HubA_/exec
-->
</html>